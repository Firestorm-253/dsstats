@using pax.dsstats.shared
@using sc2dsstats.razorlib.Services
@using System.Globalization
@using sc2dsstats.razorlib.Extensions

<div class="table-responsive tableFixHead">
    <table class="table table-dark table-striped table-hover w-auto">
        <thead class="user-select-none">
            <CascadingValue Value="orders">
                <tr>
                    <th scope="col" class="pointer" @onclick="@(e => SortList(e, nameof(CmdrPlayerInfo.RegionId)))">
                        <SortArrow Property="@nameof(CmdrPlayerInfo.RegionId)">
                            <div class="text-center">
                                <span class="oi oi-globe rounded-circle bg-primary p-1"></span>
                            </div>
                        </SortArrow>
                    </th>
                    <th scope="col" class="pointer text-info"
                        @onclick="@(e => SortList(e, nameof(CmdrPlayerInfo.Name)))">
                        <SortArrow Property="@nameof(CmdrPlayerInfo.Name)">
                            Name
                        </SortArrow>
                    </th>
                    <th scope="col" class="pointer" @onclick="@(e => SortList(e, nameof(CmdrPlayerInfo.Count)))">
                        <SortArrow Property="@nameof(CmdrPlayerInfo.Count)">
                            Games
                        </SortArrow>
                    </th>
                    <th scope="col" class="pointer" @onclick="@(e => SortList(e, "Winrate"))">
                        <SortArrow Property="Winrate">
                            Winrate
                        </SortArrow>
                    </th>
                    <th scope="col" class="pointer text-warning"
                        @onclick="@(e => SortList(e, nameof(CmdrPlayerInfo.AvgRating)))">
                        <SortArrow Property="@nameof(CmdrPlayerInfo.AvgRating)">
                            AvgRating
                        </SortArrow>
                    </th>
                    <th scope="col" class="pointer" style="z-index: 1;"
                        @onclick="@(e => SortList(e, nameof(CmdrPlayerInfo.AvgGain)))">
                        <SortArrow Property="@nameof(CmdrPlayerInfo.AvgGain)">
                            AvgGain
                        </SortArrow>
                    </th>
                </tr>
            </CascadingValue>
        </thead>
        <tbody>
            @foreach (var info in GetSortedList())
            {
                <tr class="pointer"
                    @onclick="e => OnPlayerDetailsRequest.InvokeAsync(new() { Name = info.Name, ToonId = info.ToonId, RegionId = info.RegionId })">
                    <td>@Data.GetRegionString(info.RegionId)</td>
                    <td>
                        <span class="text-truncate text-info" style="display: block; width: 130px;">@info.Name</span>
                    </td>
                    <td>@info.Count</td>
                    <td>@HelperService.GetPercentageString(info.Wins, info.Count)</td>
                    <td class="text-warning">@info.AvgRating</td>
                    <td class="@(info.AvgGain >= 0 ? "text-success" : "text-danger")">
                        <span class="@(info.AvgGain >= 0 ? "oi oi-arrow-top" : "oi oi-arrow-bottom")"></span>
                        @info.AvgGain.ToString("N2", CultureInfo.InvariantCulture)
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>


@code {
    [Parameter, EditorRequired]
    public List<CmdrPlayerInfo> CmdrPlayerInfos { get; set; } = default!;

    [Parameter]
    public EventCallback<RequestNames> OnPlayerDetailsRequest { get; set; }

    private List<TableOrder> orders = new()
{
new TableOrder()
{
Property = nameof(CmdrPlayerInfo.Count)
}
};


    private void SortList(MouseEventArgs e, string property)
    {
        var exOrder = orders.FirstOrDefault(f => f.Property == property);
        if (e.ShiftKey)
        {
            if (exOrder == null)
            {
                orders.Add(new TableOrder()
                    {
                        Property = property
                    });
            }
            else
            {
                exOrder.Ascending = !exOrder.Ascending;
            }
        }
        else
        {
            orders.Clear();
            orders.Add(new TableOrder()
                {
                    Property = property,
                    Ascending = exOrder == null ? false : !exOrder.Ascending
                });
        }
    }

    private List<CmdrPlayerInfo> GetSortedList()
    {
        var list = CmdrPlayerInfos.AsQueryable();
        foreach (var order in orders)
        {
            if (order.Property == "Winrate")
            {
                if (order.Ascending)
                {
                    list = list.OrderBy(o => o.Count == 0 ? 0 : o.Wins * 100.0 / o.Count);
                }
                else
                {
                    list = list.OrderByDescending(o => o.Count == 0 ? 0 : o.Wins * 100.0 / o.Count);
                }
            }
            else
            {
                if (order.Ascending)
                {
                    list = list.AppendOrderBy(order.Property);
                }
                else
                {
                    list = list.AppendOrderByDescending(order.Property);
                }
            }
        }
        return list.ToList();
    }

}