@page "/builds"
@using pax.dsstats.dbng.Services;
@using pax.dsstats.shared;
@using sc2dsstats.maui.Services;
@inject IRatingRepository ratingRepository
@inject IToastService toastService

<PageTitle>Builds</PageTitle>

<sc2dsstats.razorlib.Builds.BuildsNgComponent BuildRequest="buildRequest" MauiPlayers="new(defaultPlayers)"></sc2dsstats.razorlib.Builds.BuildsNgComponent>

@code {
    BuildRequest buildRequest = null!;

    List<RequestNames> defaultPlayers = new();

    protected override void OnInitialized()
    {
        defaultPlayers = GetDefaultPlayers();
        buildRequest = new()
        {
            Interest = Commander.Abathur,
            PlayerNames = defaultPlayers
        };
        base.OnInitialized();
    }

    private List<RequestNames> GetDefaultPlayers()
    {
        List<RequestNames> requestNames = new();

        foreach (var name in UserSettingsService.UserSettings.PlayerNames)
        {
            var toonIds = ratingRepository.GetNameToonIds(name);
            if (toonIds.Any())
            {
                foreach (var toonId in toonIds)
                {
                    requestNames.Add(new()
                        {
                            Name = name,
                            ToonId = toonId
                        });
                }
            }
            else
            {
                toastService.ShowWarning($"Players need at least 10 games to show up ({name})");
            }
        }

        return requestNames;
    }
}
